#!/bin/bash

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo -e "${YELLOW}ü§ñ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Ç–æ–ª—å–∫–æ –±–æ—Ç–∞...${NC}"

# –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞ (—Ç–µ–ø–µ—Ä—å /root/nova)
cd /root/nova || { echo -e "${RED}‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–π—Ç–∏ –≤ /root/nova${NC}"; exit 1; }

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ docker compose
DOCKER_COMPOSE_CMD="docker compose"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –¥–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞
echo -e "${YELLOW}üìä –°—Ç–∞—Ç—É—Å –¥–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞:${NC}"
$DOCKER_COMPOSE_CMD ps app

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —Ç–æ–ª—å–∫–æ app –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
echo -e "${YELLOW}üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ app –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞...${NC}"
$DOCKER_COMPOSE_CMD restart app

# –ñ–¥–µ–º –Ω–µ–º–Ω–æ–≥–æ –¥–ª—è –∑–∞–ø—É—Å–∫–∞
sleep 5

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞
echo -e "${YELLOW}üìä –°—Ç–∞—Ç—É—Å –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞:${NC}"
$DOCKER_COMPOSE_CMD ps app

# –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏
echo -e "${YELLOW}üìã –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏ –±–æ—Ç–∞:${NC}"
$DOCKER_COMPOSE_CMD logs --tail=10 app

# –ü—Ä–æ–≤–µ—Ä—è–µ–º healthcheck
echo -e "${YELLOW}üè• –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏:${NC}"
sleep 10
if curl -s -f http://localhost:8099/health >/dev/null 2>&1; then
    echo -e "${GREEN}‚úÖ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω –∏ –¥–æ—Å—Ç—É–ø–µ–Ω${NC}"
else
    echo -e "${RED}‚ùå –ë–æ—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω${NC}"
    echo -e "${YELLOW}üìã –ü–æ–ª–Ω—ã–µ –ª–æ–≥–∏ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏:${NC}"
    $DOCKER_COMPOSE_CMD logs app | tail -20
fi

echo -e "${GREEN}‚úÖ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –±–æ—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω!${NC}"
