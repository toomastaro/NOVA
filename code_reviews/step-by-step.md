# Пошаговый план улучшения Nova Bot

## Структура спринтов
- **1 день**: Внесение изменений
- **2 дня**: Тестирование, код-ревью и приемка
- **Итого**: 3 дня на спринт

---

## СПРИНТ 1 (3 дня) - Критические проблемы безопасности

### 1.1 Исправление проблемы с webhook URL в BotManager
**Проблема**: KeyError в `webhook_url = Config.WEBHOOK_URL_BOT.format(Config.WEBHOOK_DOMAIN, self.token)`

**Действия**:
- Заменить на f-строку: `f"{Config.WEBHOOK_DOMAIN}/webhook/{self.token}"`

**Промпт для Claude**:
```
Помоги исправить ошибку KeyError: 'BOT_TOKEN' в файле main_bot/utils/bot_manager.py. 
В функции set_webhook() и status() нужно заменить Config.WEBHOOK_URL_BOT.format() на корректный f-string. 
Покажи точные строки кода для замены.
```

### 1.2 Добавление валидации environment variables
**Действия**:
- Создать класс для проверки обязательных переменных окружения
- Добавить проверку в config.py

**Промпт для Claude**:
```
Создай класс ConfigValidator в config.py для валидации всех environment variables. 
Должны проверяться: BOT_TOKEN, PG_USER, PG_PASS, API_ID, API_HASH, CRYPTO_BOT_TOKEN, ADMINS.
Если переменная отсутствует - поднять исключение с понятным сообщением.
```

### 1.3 Добавление базового логирования вместо print()
**Действия**:
- Заменить все `print()` на `logger.info/error/debug()`
- Добавить структурированное логирование

**Промпт для Claude**:
```
Найди все использования print() в проекте Nova Bot и замени на proper логирование.
Покажи как настроить logger = logging.getLogger(__name__) для каждого модуля.
Какие уровни логирования использовать для разных типов сообщений?
```

---

## СПРИНТ 2 (3 дня) - Health checks и мониторинг

### 2.1 Добавление health check endpoints
**Действия**:
- Расширить `/health` endpoint в main_api.py
- Добавить проверку БД, Redis (если есть), внешних API

**Промпт для Claude**:
```
Создай comprehensive health check endpoint для Nova Bot. Нужно проверять:
- PostgreSQL подключение
- Telegram Bot API доступность  
- Внешние API (CryptoBot, Coinbase)
- Версия приложения
- Время работы (uptime)
Покажи код для main_api.py с async функциями проверки.
```

### 2.2 Добавление request timeout для HTTP клиентов
**Действия**:
- Настроить таймауты для всех HTTP запросов
- Добавить retry логику

**Промпт для Claude**:
```
В Nova Bot есть HTTP запросы к внешним API (CryptoBot, Coinbase, Telegram).
Покажи как добавить timeout и retry механизм для всех HTTP клиентов.
Какие timeout значения рекомендуешь? Как обрабатывать TimeoutError?
```

### 2.3 Логирование версии приложения при старте
**Действия**:
- Создать version.py файл
- Логировать версию при инициализации

**Промпт для Claude**:
```
Создай систему версионирования для Nova Bot. Нужен файл version.py с текущей версией.
При старте приложения логировать: версию, время старта, конфигурацию (без секретов).
Покажи как это интегрировать в main_api.py при старте FastAPI.
```

---

## СПРИНТ 3 (3 дня) - Обработка ошибок и валидация

### 3.1 Улучшение middleware для обработки ошибок
**Действия**:
- Расширить ErrorMiddleware с детальным логированием
- Добавить уведомления админам о критичных ошибках

**Промпт для Claude**:
```
Улучши ErrorMiddleware в main_bot/utils/middlewares.py:
1. Добавь детальное логирование ошибок с контекстом (user_id, handler, данные)
2. Для критичных ошибок - отправка уведомления админам в Telegram
3. Разные уровни обработки ошибок (recoverable vs critical)
4. Rate limiting для уведомлений админам
```

### 3.2 Валидация входящих webhook данных  
**Действия**:
- Добавить проверку структуры Telegram Update
- Валидация токенов ботов

**Промпт для Claude**:
```
Добавь валидацию для webhook endpoints в main_api.py:
1. Проверка что data содержит валидный Telegram Update
2. Проверка что токен бота существует в БД и активен
3. Rate limiting для webhook запросов
4. Логирование подозрительных запросов
Покажи код с обработкой исключений.
```

### 3.3 Валидация медиа файлов
**Действия**:
- Проверка размера файлов
- Валидация типов файлов
- Защита от загрузки вредоносных файлов

**Промпт для Claude**:
```
В main_bot/utils/functions.py есть обработка медиа (фото, видео).
Добавь валидацию:
1. Максимальный размер файлов (20MB для фото, 50MB для видео)  
2. Проверка MIME типов
3. Сканирование на вредоносный код (basic checks)
4. Обработка ошибок при обработке медиа
Покажи обновленный код функций.
```

---

## СПРИНТ 4 (3 дня) - Типизация и документация

### 4.1 Добавление типов для CRUD классов
**Действия**:
- Типизировать все методы в database/**/crud.py
- Добавить return типы для async функций

**Промпт для Claude**:
```
Добавь полную типизацию для CRUD классов в Nova Bot:
1. main_bot/database/user/crud.py
2. main_bot/database/bot_post/crud.py  
3. main_bot/database/payment/crud.py
Все параметры и возвращаемые значения должны иметь типы.
Покажи примеры с Optional, List, Union где нужно.
```

### 4.2 Типизация middleware классов
**Действия**:
- Добавить типы для middleware в utils/middleware.py
- Типизировать aiogram handlers

**Промпт для Claude**:
```
Добавь типизацию для middleware классов:
1. utils/middleware.py - SetCrud, AnswerMiddleware, ErrorMiddleware
2. main_bot/utils/middlewares.py - все middleware классы
3. Типы для aiogram handlers (Message, CallbackQuery, etc.)
Покажи правильные импорты из typing и aiogram.
```

### 4.3 Добавление docstrings (Google style)
**Действия**:
- Добавить docstrings для всех публичных функций
- Документировать основные классы

**Промпт для Claude**:
```
Добавь Google-style docstrings для ключевых модулей Nova Bot:
1. main_bot/utils/functions.py - все функции
2. main_bot/database/db.py - Database класс
3. utils/database_mixin.py - DatabaseMixin класс
Покажи примеры с Args, Returns, Raises секциями на русском языке.
```

---

## СПРИНТ 5 (3 дня) - Graceful shutdown и планировщики

### 5.1 Настройка graceful shutdown для планировщиков
**Действия**:
- Добавить обработку SIGTERM в schedulers.py
- Корректное завершение всех async задач

**Промпт для Claude**:
```
В main_bot/utils/schedulers.py нужно добавить graceful shutdown:
1. Обработка SIGTERM/SIGINT сигналов
2. Корректное завершение всех running задач  
3. Ожидание завершения текущих операций
4. Закрытие соединений с БД/API
Покажи код с asyncio.gather() и proper cleanup.
```

### 5.2 Защита от дублирования планировщиков
**Действия**:
- Добавить проверку уже запущенных планировщиков
- Redis лок или database флаг

**Промпт для Claude**:
```
Планировщики в Nova Bot могут дублироваться при перезапуске.
Реализуй защиту от дублирования:
1. Database флаг "scheduler_running" с timestamp
2. Проверка при старте - если флаг старше 5 минут, сбрасывать
3. Heartbeat каждую минуту для обновления timestamp
4. Cleanup при shutdown
Покажи код для schedulers.py.
```

### 5.3 Обработка флуд-ограничений Telegram API
**Действия**:
- Добавить retry с exponential backoff
- Учет rate limits в планировщиках

**Промпт для Claude**:
```
В schedulers.py при массовой отправке постов могут быть флуд-ограничения.
Добавь обработку:
1. Перехват TelegramAPIError с кодом 429 (Too Many Requests)
2. Exponential backoff для retry (1s, 2s, 4s, 8s)
3. Максимум 5 попыток, потом skip
4. Логирование флуд-ограничений
5. Динамическая задержка между отправками
```

---

## СПРИНТ 6 (3 дня) - Оптимизация БД и константы

### 6.1 Вынесение констант в config
**Действия**:
- Создать класс Constants в config.py
- Заменить все hardcode значения

**Промпт для Claude**:
```
В Nova Bot много hardcode констант (таймауты, лимиты, размеры).
Создай класс Constants в config.py для:
1. Таймауты API запросов
2. Лимиты размеров файлов  
3. Интервалы планировщиков
4. Rate limiting настройки
5. Retry параметры
Покажи как использовать эти константы в коде.
```

### 6.2 Оптимизация БД запросов
**Действия**:
- Добавить индексы для частых запросов
- Оптимизировать N+1 проблемы

**Промпт для Claude**:
```
Проанализируй CRUD операции в Nova Bot и предложи оптимизации:
1. Какие индексы добавить для частых запросов?
2. Где есть N+1 проблемы в SQLAlchemy?
3. Какие запросы можно batch-ить?
4. Нужно ли добавить connection pooling настройки?
Покажи SQL для создания индексов и примеры оптимизации кода.
```

### 6.3 Добавление базового кеширования
**Действия**:
- Кеширование настроек пользователей
- Кеш для статичных данных

**Промпт для Claude**:
```
Добавь простое in-memory кеширование в Nova Bot:
1. Кеш для user settings (TTL 5 минут)
2. Кеш для bot tokens validation (TTL 1 час)  
3. Кеш для tariffs/constants (TTL 1 день)
4. LRU cache с максимумом 1000 записей
Используй functools.lru_cache и asyncio-compatible решения.
```

---

## СПРИНТ 7 (3 дня) - Pre-commit хуки и линтинг

### 7.1 Настройка pre-commit хуков
**Действия**:
- Создать .pre-commit-config.yaml
- Настроить ruff, black, isort, mypy

**Промпт для Claude**:
```
Настрой pre-commit хуки для Nova Bot проекта:
1. .pre-commit-config.yaml с ruff, black, isort, mypy
2. pyproject.toml конфигурация для всех инструментов
3. Исключения для legacy файлов (.bak, migrations)
4. CI-friendly настройки
Покажи команды для установки и настройки.
```

### 7.2 Исправление линтинг ошибок
**Действия**:
- Запустить ruff check и исправить ошибки
- Форматирование с black

**Промпт для Claude**:
```
Запусти линтинг на Nova Bot проекте и покажи как исправить:
1. ruff check . - основные проблемы кода
2. black --check . - форматирование
3. isort --check . - порядок импортов
4. mypy . - проблемы типизации
Дай приоритизированный список исправлений.
```

### 7.3 Настройка mypy конфигурации
**Действия**:
- Создать mypy.ini или pyproject.toml секцию
- Настроить strict режим постепенно

**Промпт для Claude**:
```
Настрой mypy для Nova Bot с постепенным переходом на strict mode:
1. Конфигурация в pyproject.toml  
2. Исключения для aiogram типов
3. Игнорирование missing imports для внешних библиотек
4. Per-module настройки строгости
Покажи поэтапный план включения строгих проверок.
```

---

## СПРИНТ 8 (3 дня) - Базовые unit тесты

### 8.1 Настройка pytest инфраструктуры
**Действия**:
- Создать tests/ структуру
- Настроить fixtures для БД

**Промпт для Claude**:
```
Создай pytest инфраструктуру для Nova Bot:
1. tests/ структура директорий
2. conftest.py с fixtures для БД, mock'ов API
3. Тестовая БД конфигурация
4. Fixtures для создания тестовых данных (users, bots, posts)
5. pytest.ini настройки
Покажи базовые fixtures и примеры их использования.
```

### 8.2 Unit тесты для CRUD операций
**Действия**:
- Тесты для UserCrud
- Тесты для основных database операций

**Промпт для Claude**:
```
Напиши unit тесты для CRUD операций Nova Bot:
1. test_user_crud.py - все методы UserCrud
2. test_bot_crud.py - основные операции UserBotCrud  
3. test_payment_crud.py - создание и обновление платежей
Покажи примеры тестов с async/await, fixtures, assertions.
Какие edge cases важно покрыть?
```

### 8.3 Тесты для utility функций
**Действия**:
- Тестирование функций в utils/
- Тесты обработки медиа

**Промпт для Claude**:
```
Создай unit тесты для utility функций:
1. utils/functions.py - функция create_emoji
2. main_bot/utils/functions.py - обработка медиа файлов
3. utils/database_mixin.py - DatabaseMixin методы
Как тестировать асинхронные функции с моками?
Как мокать внешние API вызовы?
```

---

## СПРИНТ 9 (3 дня) - Мониторинг и алертинг

### 9.1 Интеграция с Sentry для мониторинга ошибок
**Действия**:
- Установить sentry-sdk
- Настроить в main_api.py

**Промпт для Claude**:
```
Интегрируй Sentry в Nova Bot для мониторинга ошибок:
1. Установка sentry-sdk[fastapi]
2. Настройка в main_api.py с DSN из env
3. Custom tags для разных типов ошибок (bot_id, user_id)
4. Filtering чувствительных данных
5. Performance monitoring для критических операций
Покажи код настройки и примеры использования.
```

### 9.2 Метрики для основных операций
**Действия**:
- Счетчики успешных/неуспешных операций
- Время выполнения critical path

**Промпт для Claude**:
```
Добави метрики в Nova Bot (без Prometheus, простые счетчики):
1. Счетчики в memory: успешные/неуспешные отправки постов
2. Время выполнения webhook обработки  
3. Количество активных пользователей/ботов
4. API endpoints для получения метрик (/metrics)
5. Периодическое логирование статистики
Покажи implementation с asyncio и без внешних зависимостей.
```

### 9.3 Алертинг админам в Telegram
**Действия**:
- Уведомления о критичных ошибках
- Дайджест статистики

**Промпт для Claude**:
```
Создай систему алертинга админам в Telegram:
1. Немедленные уведомления при критичных ошибках
2. Rate limiting - не более 1 сообщения в 5 минут на тип ошибки
3. Ежедневный дайджест: статистика, ошибки, метрики
4. Команды админа для получения status /admin_status
5. Форматированные сообщения с контекстом
Покажи код для admin notifications системы.
```

---

## СПРИНТ 10 (3 дня) - CORS и security headers

### 10.1 Добавление CORS headers
**Действия**:
- Настроить CORS middleware в FastAPI
- Безопасные настройки для production

**Промпт для Claude**:
```
Настрой CORS для Nova Bot FastAPI приложения:
1. CORS middleware с правильными origins
2. Разные настройки для dev/prod окружений
3. Безопасные headers (X-Frame-Options, Content-Security-Policy)  
4. Rate limiting middleware
5. Логирование CORS violations
Покажи код middleware и security настройки.
```

### 10.2 Улучшение безопасности секретов
**Действия**:
- Маскирование секретов в логах
- Валидация .env файла

**Промпт для Claude**:
```
Улучши безопасность секретов в Nova Bot:
1. Маскирование токенов в логах (показывать только первые/последние символы)
2. Валидация формата секретов (BOT_TOKEN, API_HASH)
3. Предупреждения о слабых паролях БД
4. Ротация session files периодически  
5. Secure headers в HTTP ответах
Покажи код для secrets management.
```

### 10.3 Аудит безопасности с bandit
**Действия**:
- Запуск bandit проверки
- Исправление найденных уязвимостей

**Промпт для Claude**:
```
Проведи security audit Nova Bot проекта:
1. Запусти bandit -r . для поиска уязвимостей
2. Исправь найденные проблемы с безопасностью
3. Настрой bandit.yaml конфигурацию с исключениями
4. Добавь bandit в pre-commit хуки
5. Создай security checklist для code review
```

---

## Финальный СПРИНТ 11 (3 дня) - Интеграционные тесты

### 11.1 End-to-end тест webhook flow
**Действия**:
- Тест полного цикла webhook → handler → response
- Мокирование Telegram API

**Промпт для Claude**:
```
Создай end-to-end тест для Nova Bot webhook flow:
1. Симуляция входящего webhook от Telegram
2. Обработка через все middleware
3. Вызов handler и проверка результата
4. Мокирование всех внешних API вызовов
5. Проверка правильности логирования
Покажи код интеграционного теста с TestClient.
```

### 11.2 Тестирование database миграций
**Действия**:
- Тесты создания схем для новых ботов
- Rollback тестирование

**Промпт для Claude**:
```
Создай тесты для database operations:
1. Тест создания новой схемы для user bot
2. Тест миграций БД (если добавляются новые таблицы)
3. Тест rollback операций
4. Тест concurrent доступа к БД
5. Тест cleanup при удалении бота
Как тестировать database schema changes safely?
```

### 11.3 Performance тестирование
**Действия**:
- Нагрузочное тестирование webhook endpoint
- Тестирование memory leaks

**Промпт для Claude**:
```
Создай performance тесты для Nova Bot:
1. Нагрузочный тест webhook endpoint (100+ RPS)
2. Memory leak тестирование при длительной работе
3. Database connection pooling под нагрузкой
4. Тест планировщиков с большим количеством постов
5. Profiling critical paths
Какие инструменты использовать для performance testing в Python?
```

---

## Итоговый чеклист готовности

### Перед деплоем на production:
- [ ] Все unit тесты проходят (coverage > 80%)
- [ ] Интеграционные тесты проходят
- [ ] Линтинг проходит без ошибок
- [ ] Security audit чистый
- [ ] Health checks работают корректно
- [ ] Логирование настроено для production
- [ ] Мониторинг и алертинг работают
- [ ] Backup и recovery процедуры протестированы
- [ ] Performance тесты показывают приемлемые результаты
- [ ] Documentation обновлена

### Команды для финальной проверки:
```bash
# Полная проверка кода
ruff check .
black --check .
isort --check .
mypy .
bandit -r . -f json

# Тестирование
pytest tests/ -v --cov=. --cov-report=html
pytest tests/integration/ -v

# Security check
safety check
pip-audit

# Performance baseline
ab -n 1000 -c 10 http://localhost:8099/health
```

---

## Дополнительные промпты для решения проблем

### Отладка сложных ошибок:
```
У меня ошибка [вставить traceback] в Nova Bot. 
Проанализируй stacktrace и предложи решение.
Какие дополнительные логи добавить для диагностики?
```

### Оптимизация производительности:
```
Nova Bot работает медленно при [описать ситуацию].
Предложи способы профилирования и оптимизации.
Какие bottlenecks проверить в первую очередь?
```

### Рефакторинг кода:
```
В файле [название] есть дублированный код [вставить код].
Как лучше отрефакторить с сохранением функциональности?
Предложи паттерн проектирования.
```

Этот план рассчитан на ~33 дня активной разработки (11 спринтов по 3 дня). Каждый спринт можно выполнять независимо, с возможностью приоритизации наиболее критичных задач.